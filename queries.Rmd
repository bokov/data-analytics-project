---
title: "Problem Set 1"
author: "Benjamin Cordier"
date: "6/21/2017"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Compute LACE Score

## Setup

```{r}

# Load Libraries
library(RSQLite)
library(zoo)
library(tidyverse)
library(broom)
library(caret)
library(ROCR)

# Global References
seed 			<- 111
partition 		<- 0.8
dependent 		<- "readmit_30"
database.name 	<- "patient1.sqlite" 	# Database name
data.dir 		<- "data/raw/"			# Data file directory
data.format 	<- ".txt"				# Data file format
data.overwrite	<- TRUE 				# Helps on development, but not something to default to TRUE
data.frames 	<- list()

# Connect to SQLite DB
SQLiteConnection <- dbConnect(drv = SQLite(), dbname = database.name)

# Iterate Through Data Files & Load into SQLite DB - Indicate Whether Each Query is Successful or Not
for (file in list.files(data.dir)) {
	key 	<- sub(data.format, "", file)
	path    <- paste(data.dir, file, sep = "")
	val 	<- read.table(path, header = TRUE, sep = "|")
	# Loading into DBs Can be Error Prone, Wrap It in a TryCatch For Fun
	handle 	<- tryCatch ({
			# Write SQLite Table from DF
			message("Writing table: ", key)
			dbWriteTable(conn = SQLiteConnection, name = key, value = val, overwrite = data.overwrite)
		},
		# Output Any Errors
		error = function (status) {
			message("Error writing table: ", key)
			message(status, "\r")
		},
		# Output Any Warnings
		warning = function (status) {
			message("A warning occurred while writing table: ", key)
			message(status, "\r")
		},
		# Validate Table Creation via Comparison of n SQL Table Rows to n DF Rows
		finally = {
			query 	<- paste("select count(*) from", key)
			result 	<- dbGetQuery(SQLiteConnection, query)
			valid 	<- (nrow(val) == result)[1,]
			if (valid) {
				message("Table validated: ", key, "\n")
			} else {
				message("Table invalid: ", key, "\n")
			}
		}
	)
}

# Connect To DB
SQLiteConnection <- dbConnect(drv = SQLite(), dbname = "db/patient.sqlite")

# Get patient_encounter_hosp_mod
sqlStatement <- "SELECT * FROM patient_encounter_hosp_mod"
pehm <- dbGetQuery(SQLiteConnection, sqlStatement)

# Create Analytics Table Reference
analytics.table <- pehm

# Print Out Table
analytics.table[1:10,]

```

## Problem Set 1 – L

```{r}

# Compute Column L - Note We Offset By -1 On Conditions Because Both Admission & Discharge Dates Count 
sqlStatement <- "
	SELECT PEH.*, 
		CASE
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) = 1
				THEN 1
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) = 2
				THEN 2
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) = 3
				THEN 3
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) > 3 AND julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) < 7 
				THEN 4
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) > 6 AND julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) < 14 
				THEN 5
			WHEN julianday(PEH.Discharge_date) - julianday(PEH.Admit_date) > 14 
				THEN 7
			ELSE 0
		END AS L
	FROM patient_encounter_hosp_mod as PEH
	WHERE PEH.index_admit=1
"

# Query & Verify Result
queryResult <- dbGetQuery(SQLiteConnection, sqlStatement, overwrite = TRUE)
queryResult[1:10,]

# Set Analytics Table To This Query Result As Starting Point
analytics.table <- queryResult

# How Many Rows Do We Have?
message("n Rows: ", dim(analytics.table)[1])

```

# Problem Set 1 – A
```{r}

# Compute Column A
sqlStatement <- "
	SELECT PEH.*, 
		CASE
			WHEN PEH.Admit_source = 'Emergency Room'
				THEN 3
			ELSE 0
		END AS A
	FROM patient_encounter_hosp_mod AS PEH
	WHERE PEH.index_admit=1
"

# Query & Verify Result
queryResult <- dbGetQuery(SQLiteConnection, sqlStatement)
queryResult[1:10,]

# Append A to Analytics Table
analytics.table$A <- queryResult$A

# Show Updated Table
analytics.table[1:10,]

```

## Problem Set 2 – C 

```{r}

# Narrow By ICD-9 Codes And Match To String
# ICD-9 Codes Manually Reviewed & Source From: https://en.wikipedia.org/wiki/List_of_ICD-9_codes](https://en.wikipedia.org/wiki/List_of_ICD-9_codes
# Loose Weighting Scheme:
# 	Diabetes 	= 2
# 	MCI 		= 2
#	CAD 		= 2
#	CHF 		= 3
#	Asthma 		= 1
#	Hepatitis C = 2
#	Dementia 	= 2
#	Stroke 		= 3
#	Depression 	= 1
#	PVD 		= 2
# Why, No Clue, I Have Little Domain Knowledge Here – It Just Felt Right ;)
#
# String Matching Was Done For Conditions Without Specific ICD-9 Codes:
# 	CAD
# 	Asthma
# 	Hepatitis C
# 	Stroke

sqlStatement <- "
	SELECT patientid,
	-- Diabetes
		CASE
			WHEN icd9code LIKE '250.40'
				OR icd9code LIKE '250.50'
				OR icd9code LIKE '250.60'
					THEN 1
			ELSE 0
		END AS icd_diabetes,
	-- Myocardial Infarction
		CASE
			WHEN icd9code LIKE '412%'
				OR icd9code LIKE '410%'
					THEN 1
			ELSE 0
		END AS icd9_mci,
	-- CAD 
		CASE 
			WHEN icd9code LIKE '410%'
				AND UPPER(diagnosis_name) LIKE '%CORONARY%'
					THEN 1
			ELSE 0
		END AS icd9_cad,
	-- CHF
		CASE 
			WHEN icd9code LIKE '428%'
				OR icd9code LIKE '425.4%'
				OR icd9code LIKE '425.5%'
				OR icd9code LIKE '425.6%'
				OR icd9code LIKE '425.7%'
				OR icd9code LIKE '425.8%'
				OR icd9code LIKE '425.9%'
				OR icd9code LIKE '398.91'
				OR icd9code LIKE '402.01'
				OR icd9code LIKE '402.11'
				OR icd9code LIKE '402.91'
				OR icd9code LIKE '404.01'
				OR icd9code LIKE '404.03'
				OR icd9code LIKE '404.11'
				OR icd9code LIKE '404.13'
				OR icd9code LIKE '404.91'
				OR icd9code LIKE '404.93'
					THEN 1
			ELSE 0
		END AS icd9_chf,
	-- Asthma
		CASE 
			WHEN icd9code LIKE '493%'
				AND UPPER(diagnosis_name) LIKE '%ASTHMA%'
				THEN 1
			ELSE 0
		END AS icd9_asthma,
	-- Hepatitis C
		CASE
			WHEN icd9code LIKE '070%'
				AND UPPER(diagnosis_name) LIKE '%HEPATITIS C%'
					THEN 1
			ELSE 0
		END AS icd9_hepatitis_c,
	-- Dementia
		CASE
			WHEN
				icd9code LIKE '331.2%'
				OR icd9code LIKE '94.1'
				OR icd9code LIKE '290%'
				OR icd9code LIKE '294.1%'
				OR icd9code LIKE '294.2%'
				OR icd9code LIKE '294.8%'
				OR icd9code LIKE '331.11'
				OR icd9code LIKE '331.19'
				OR icd9code LIKE '331.82'
					THEN 1
			ELSE 0
		END AS icd9_dementia,
	-- Stroke
		CASE
			WHEN (
				icd9code LIKE '433%'
				OR icd9code LIKE '434%'
			) AND UPPER(diagnosis_name) LIKE '%STROKE%'
					THEN 1
			ELSE 0
		END AS icd9_stroke,
	-- Depression
		CASE
			WHEN 
				icd9code LIKE '296.2%'
				OR icd9code LIKE '296.3%'
				OR icd9code LIKE '296.5%'
				OR icd9code LIKE '300.4%'
				OR icd9code LIKE '309%'
				OR icd9code LIKE '311%'
					THEN 1
			ELSE 0
		END AS icd9_depression,
	-- PVD
		CASE
			WHEN 
				icd9code LIKE '093.0%'
				OR icd9code LIKE '437.3%'
				OR icd9code LIKE '440.%'
				OR icd9code LIKE '441.%'
				OR icd9code LIKE '443.1%'
				OR icd9code LIKE '443.2%'
				OR icd9code LIKE '443.3%'
				OR icd9code LIKE '443.4%'
				OR icd9code LIKE '443.5%'
				OR icd9code LIKE '443.6%'
				OR icd9code LIKE '443.7%'
				OR icd9code LIKE '443.8%'
				OR icd9code LIKE '443.9%'
				OR icd9code LIKE '447.1%'
				OR icd9code LIKE '557.1%'
				OR icd9code LIKE '557.9%'
				OR icd9code LIKE 'V43.4%'
					THEN 1
			ELSE 0
		END AS icd9_pvd

	FROM patient_diagnosis AS PD
	GROUP BY patientid
"

# Query
queryResult <- dbGetQuery(SQLiteConnection, sqlStatement)
queryResult[1:10,]

# Compute E
queryResult$C <- (
	queryResult$icd9_cad + 
	queryResult$icd9_chf + 
	queryResult$icd9_asthma + 
	queryResult$icd9_hepatitis_c + 
	queryResult$icd9_dementia + 
	queryResult$icd9_stroke + 
	queryResult$icd9_depression + 
	queryResult$icd9_pvd
)

# Summarize Query
summary(queryResult)

# Merge E Into Analytics Table
analytics.table <- merge(analytics.table, queryResult[c("patientid", "C")], by = "patientid", all.x = TRUE)

# Patients Should Have Multiple Comorbidities
analytics.table[c(462, 551, 1075),]

# How Many Rows Do We Have?
message("n Rows: ", dim(analytics.table)[1])

```

## Problem Set 1 – E 

```{r}

# Compute Column E
sqlStatement <- "
	SELECT patientid, 
		CASE
			WHEN SUM(Emergency_department) = 0
				THEN 0
			WHEN SUM(Emergency_department) < 5 AND SUM(Emergency_department) > 0
				THEN SUM(Emergency_department) - 1
			ELSE 4
		END AS E
	FROM (
		SELECT PE.*,
			CASE
				WHEN PE.encounter_type = 48
					THEN 1
				ELSE 0
			END AS Emergency_department
		FROM patient_encounter_hosp_mod AS PEH
		LEFT JOIN patient_encounter AS PE
		ON PE.patientid = PEH.patientid
			AND PE.Outcome = 'COMPLETE'
			AND date(PE.Actual_Date) > date(PEH.Admit_date, '-180 day')
	)
	GROUP BY patientid
"

# Query & Verify Result
queryResult <- dbGetQuery(SQLiteConnection, sqlStatement)
queryResult[0:10,]

# Merge E Into Analytics Table
analytics.table <- merge(analytics.table, queryResult, by = "patientid", all.x = TRUE)

# Show Updated Table
analytics.table[0:10,]

# Disconnect From Database
dbDisconnect(SQLiteConnection)

```

## Problem Set 2 – LACE Sum

```{r}

analytics.table$LACE_sum <- (
	analytics.table$L + 
	analytics.table$A + 
	analytics.table$C + 
	analytics.table$E
)

# Show Analytics Table
analytics.table[1:10,]

# Summarize
summary(analytics.table)

# How Many Rows Do We Have?
message("n Rows: ", dim(analytics.table)[1])

```

## Dump Analytics Table to RDS
```{r}

# Save Analytics Table As R Data Object
saveRDS(analytics.table, "data/analytics.rdata")

```